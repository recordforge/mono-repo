<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    #vis.vega-embed {
      width: 100%;
      display: flex;
    }

    #vis.vega-embed details,
    #vis.vega-embed details summary {
      position: relative;
    }
  </style>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vega-lite@5.20.1"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
</head>
<body>
  <div id="vis"></div>
  <script>
    (function(vegaEmbed) {
      var spec = {"config": {"view": {"continuousWidth": 400, "continuousHeight": 300}}, "layer": [{"layer": [{"mark": "rule", "encoding": {"color": {"value": "black"}, "size": {"value": 0.5}, "y": {"field": "zero", "type": "quantitative"}}}, {"mark": {"type": "bar", "width": 60}, "encoding": {"color": {"condition": {"test": "(datum.log2_bayes_factor < 0)", "value": "red"}, "value": "green"}, "opacity": {"condition": {"test": "datum.column_name == 'Prior match weight' || datum.column_name == 'Final score'", "value": 1}, "value": 0.5}, "tooltip": [{"field": "column_name", "title": "Comparison column", "type": "nominal"}, {"field": "value_l", "title": "Value (L)", "type": "nominal"}, {"field": "value_r", "title": "Value (R)", "type": "nominal"}, {"field": "label_for_charts", "title": "Label", "type": "ordinal"}, {"field": "sql_condition", "title": "SQL condition", "type": "nominal"}, {"field": "comparison_vector_value", "title": "Comparison vector value", "type": "nominal"}, {"field": "bayes_factor", "format": ",.4f", "title": "Bayes factor = m/u", "type": "quantitative"}, {"field": "log2_bayes_factor", "format": ",.4f", "title": "Match weight = log2(m/u)", "type": "quantitative"}, {"field": "prob", "format": ".4f", "title": "Cumulative match probability", "type": "quantitative"}, {"field": "bayes_factor_description", "title": "Match weight description", "type": "nominal"}], "x": {"axis": {"grid": true, "labelAlign": "center", "labelAngle": -20, "labelExpr": "datum.value == 'Prior' || datum.value == 'Final score' ? '' : datum.value", "labelPadding": 10, "tickBand": "extent", "title": "Column"}, "field": "column_name", "sort": {"field": "bar_sort_order", "order": "ascending"}, "type": "nominal"}, "y": {"axis": {"grid": false, "orient": "left", "title": "Match Weight"}, "field": "previous_sum", "type": "quantitative"}, "y2": {"field": "sum"}}}, {"mark": {"type": "text", "fontWeight": "bold"}, "encoding": {"color": {"value": "white"}, "text": {"condition": {"test": "abs(datum.log2_bayes_factor) > 1", "field": "log2_bayes_factor", "format": ".2f", "type": "nominal"}, "value": ""}, "x": {"axis": {"labelAngle": -20, "title": "Column"}, "field": "column_name", "sort": {"field": "bar_sort_order", "order": "ascending"}, "type": "nominal"}, "y": {"axis": {"orient": "left"}, "field": "center", "type": "quantitative"}}}, {"mark": {"type": "text", "baseline": "bottom", "dy": -25, "fontWeight": "bold"}, "encoding": {"color": {"value": "black"}, "text": {"field": "column_name", "type": "nominal"}, "x": {"axis": {"labelAngle": -20, "title": "Column"}, "field": "column_name", "sort": {"field": "bar_sort_order", "order": "ascending"}, "type": "nominal"}, "y": {"field": "sum_top", "type": "quantitative"}}}, {"mark": {"type": "text", "baseline": "bottom", "dy": -13, "fontSize": 8}, "encoding": {"color": {"value": "grey"}, "text": {"field": "value_l", "type": "nominal"}, "x": {"axis": {"labelAngle": -20, "title": "Column"}, "field": "column_name", "sort": {"field": "bar_sort_order", "order": "ascending"}, "type": "nominal"}, "y": {"field": "sum_top", "type": "quantitative"}}}, {"mark": {"type": "text", "baseline": "bottom", "dy": -5, "fontSize": 8}, "encoding": {"color": {"value": "grey"}, "text": {"field": "value_r", "type": "nominal"}, "x": {"axis": {"labelAngle": -20, "title": "Column"}, "field": "column_name", "sort": {"field": "bar_sort_order", "order": "ascending"}, "type": "nominal"}, "y": {"field": "sum_top", "type": "quantitative"}}}]}, {"mark": {"type": "rule", "color": "black", "strokeWidth": 2, "x2Offset": 30, "xOffset": -30}, "encoding": {"x": {"axis": {"labelAngle": -20, "title": "Column"}, "field": "column_name", "sort": {"field": "bar_sort_order", "order": "ascending"}, "type": "nominal"}, "x2": {"field": "lead"}, "y": {"axis": {"labelExpr": "format(1 / (1 + pow(2, -1*datum.value)), '.2r')", "orient": "right", "title": "Probability"}, "field": "sum", "scale": {"zero": false}, "type": "quantitative"}}}], "data": {"name": "data-b14056e0a145f8f599067c9a5745e735"}, "height": 450, "params": [{"name": "record_number", "bind": {"input": "range", "max": 0, "min": 0, "step": 1}, "value": 0}], "resolve": {"axis": {"y": "independent"}}, "title": {"text": "Match weights waterfall chart", "subtitle": "How each comparison contributes to the final match score"}, "transform": [{"filter": "(datum.record_number == record_number)"}, {"filter": "(datum.bayes_factor !== 1.0)"}, {"window": [{"op": "sum", "field": "log2_bayes_factor", "as": "sum"}, {"op": "lead", "field": "column_name", "as": "lead"}], "frame": [null, 0]}, {"calculate": "datum.column_name === \"Final score\" ? datum.sum - datum.log2_bayes_factor : datum.sum", "as": "sum"}, {"calculate": "datum.lead === null ? datum.column_name : datum.lead", "as": "lead"}, {"calculate": "datum.column_name === \"Final score\" || datum.column_name === \"Prior match weight\" ? 0 : datum.sum - datum.log2_bayes_factor", "as": "previous_sum"}, {"calculate": "datum.sum > datum.previous_sum ? datum.column_name : \"\"", "as": "top_label"}, {"calculate": "datum.sum < datum.previous_sum ? datum.column_name : \"\"", "as": "bottom_label"}, {"calculate": "datum.sum > datum.previous_sum ? datum.sum : datum.previous_sum", "as": "sum_top"}, {"calculate": "datum.sum < datum.previous_sum ? datum.sum : datum.previous_sum", "as": "sum_bottom"}, {"calculate": "(datum.sum + datum.previous_sum) / 2", "as": "center"}, {"calculate": "(datum.log2_bayes_factor > 0 ? \"+\" : \"\") + datum.log2_bayes_factor", "as": "text_log2_bayes_factor"}, {"calculate": "datum.sum < datum.previous_sum ? 4 : -4", "as": "dy"}, {"calculate": "datum.sum < datum.previous_sum ? \"top\" : \"bottom\"", "as": "baseline"}, {"calculate": "1. / (1 + pow(2, -1.*datum.sum))", "as": "prob"}, {"calculate": "0*datum.sum", "as": "zero"}], "width": {"step": 75}, "$schema": "https://vega.github.io/schema/vega-lite/v5.9.3.json", "datasets": {"data-b14056e0a145f8f599067c9a5745e735": [{"column_name": "Prior", "label_for_charts": "Starting match weight (prior)", "sql_condition": null, "log2_bayes_factor": -10.249460372549692, "bayes_factor": 0.0008214951211204392, "comparison_vector_value": null, "m_probability": null, "u_probability": null, "bayes_factor_description": null, "value_l": "", "value_r": "", "term_frequency_adjustment": null, "bar_sort_order": 0, "record_number": 0}, {"sql_condition": "jaro_winkler_similarity(\"first_name_l\", \"first_name_r\") >= 0.8", "label_for_charts": "Jaro-Winkler distance of first_name >= 0.8", "m_probability": 0.06736301794835056, "u_probability": 0.03333333333333336, "bayes_factor": 2.0208905384505154, "log2_bayes_factor": 1.0149911802473903, "comparison_vector_value": 1, "bayes_factor_description": "If comparison level is `jaro-winkler distance of first_name >= 0.8` then comparison is 2.021 times more likely to be a match", "column_name": "first_name", "value_l": "Robert", "value_r": "Rob", "term_frequency_adjustment": false, "bar_sort_order": 1, "record_number": 0}, {"sql_condition": "jaro_winkler_similarity(\"first_name_l\", \"first_name_r\") >= 0.8", "label_for_charts": "Jaro-Winkler distance of first_name >= 0.8", "m_probability": 0.06736301794835056, "u_probability": 0.03333333333333336, "bayes_factor": 1.0, "log2_bayes_factor": 0.0, "comparison_vector_value": 1, "bayes_factor_description": "If comparison level is `jaro-winkler distance of first_name >= 0.8` then comparison is 2.021 times more likely to be a match", "column_name": "tf_first_name", "value_l": "", "value_r": "", "term_frequency_adjustment": true, "bar_sort_order": 2, "record_number": 0}, {"sql_condition": "\"surname_l\" = \"surname_r\"", "label_for_charts": "Exact match on surname", "m_probability": 0.5509949405373061, "u_probability": 0.000927734375, "bayes_factor": 593.9145464317911, "log2_bayes_factor": 9.214111557993046, "comparison_vector_value": 3, "bayes_factor_description": "If comparison level is `exact match on surname` then comparison is 594 times more likely to be a match", "column_name": "surname", "value_l": "Allen", "value_r": "Allen", "term_frequency_adjustment": false, "bar_sort_order": 3, "record_number": 0}, {"sql_condition": "\"surname_l\" = \"surname_r\"", "label_for_charts": "Term freq adjustment on surname with weight {cl.tf_adjustment_weight}", "m_probability": null, "u_probability": null, "bayes_factor": 0.3799072265625, "log2_bayes_factor": -1.3962809398027682, "comparison_vector_value": 3, "bayes_factor_description": "Term frequency adjustment on surname makes comparison  2.63 times less likely to be a match", "column_name": "tf_surname", "value_l": "Allen", "value_r": "Allen", "term_frequency_adjustment": true, "bar_sort_order": 4, "record_number": 0}, {"sql_condition": "damerau_levenshtein(\"dob_l\", \"dob_r\") <= 1", "label_for_charts": "DamerauLevenshtein distance <= 1", "m_probability": 0.08378423880863277, "u_probability": 0.0012500000000000011, "bayes_factor": 67.02739104690616, "log2_bayes_factor": 6.066678874816735, "comparison_vector_value": 4, "bayes_factor_description": "If comparison level is `dameraulevenshtein distance <= 1` then comparison is 67.03 times more likely to be a match", "column_name": "dob", "value_l": "1971-05-24", "value_r": "1971-06-24", "term_frequency_adjustment": false, "bar_sort_order": 5, "record_number": 0}, {"sql_condition": "\"city_l\" IS NULL OR \"city_r\" IS NULL", "label_for_charts": "city is NULL", "bayes_factor": 1.0, "log2_bayes_factor": 0.0, "comparison_vector_value": -1, "bayes_factor_description": "If comparison level is `city is null` then comparison is 1 times more likely to be a match", "column_name": "city", "value_l": "None", "value_r": "London", "term_frequency_adjustment": false, "bar_sort_order": 6, "record_number": 0}, {"sql_condition": "\"city_l\" IS NULL OR \"city_r\" IS NULL", "label_for_charts": "city is NULL", "bayes_factor": 1.0, "log2_bayes_factor": 0.0, "comparison_vector_value": -1, "bayes_factor_description": "If comparison level is `city is null` then comparison is 1 times more likely to be a match", "column_name": "tf_city", "value_l": "", "value_r": "", "term_frequency_adjustment": true, "bar_sort_order": 7, "record_number": 0}, {"sql_condition": "\"email_l\" = \"email_r\"", "label_for_charts": "Exact match on email", "m_probability": 0.5928147467744491, "u_probability": 0.000927734375, "bayes_factor": 638.9918954705641, "log2_bayes_factor": 9.319653822921056, "comparison_vector_value": 4, "bayes_factor_description": "If comparison level is `exact match on email` then comparison is 639 times more likely to be a match", "column_name": "email", "value_l": "roberta25@smith.net", "value_r": "roberta25@smith.net", "term_frequency_adjustment": false, "bar_sort_order": 8, "record_number": 0}, {"sql_condition": "\"email_l\" = \"email_r\"", "label_for_charts": "Term freq adjustment on email with weight {cl.tf_adjustment_weight}", "m_probability": null, "u_probability": null, "bayes_factor": 0.36599121093750003, "log2_bayes_factor": -1.4501190914303181, "comparison_vector_value": 4, "bayes_factor_description": "Term frequency adjustment on email makes comparison  2.73 times less likely to be a match", "column_name": "tf_email", "value_l": "roberta25@smith.net", "value_r": "roberta25@smith.net", "term_frequency_adjustment": true, "bar_sort_order": 9, "record_number": 0}, {"column_name": "Final score", "label_for_charts": "Final score", "sql_condition": null, "log2_bayes_factor": 12.51957503219545, "bayes_factor": 5871.7508274401935, "comparison_vector_value": null, "m_probability": null, "u_probability": null, "bayes_factor_description": null, "value_l": "", "value_r": "", "term_frequency_adjustment": null, "bar_sort_order": 10, "record_number": 0}]}};
      var embedOpt = {"mode": "vega-lite"};

      function showError(el, error){
          el.innerHTML = ('<div style="color:red;">'
                          + '<p>JavaScript Error: ' + error.message + '</p>'
                          + "<p>This usually means there's a typo in your chart specification. "
                          + "See the javascript console for the full traceback.</p>"
                          + '</div>');
          throw error;
      }
      const el = document.getElementById('vis');
      vegaEmbed("#vis", spec, embedOpt)
        .catch(error => showError(el, error));
    })(vegaEmbed);

  </script>
</body>
</html>